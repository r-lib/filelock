<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Place an exclusive or shared lock on a file. It uses
    LockFile on Windows and fcntl locks on Unix-like systems.">
<title>Portable File Locking • filelock</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Source_Sans_Pro-0.4.8/font.css" rel="stylesheet">
<link href="deps/Source_Code_Pro-0.4.8/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Portable File Locking">
<meta property="og:description" content="Place an exclusive or shared lock on a file. It uses
    LockFile on Windows and fcntl locks on Unix-like systems.">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="/r-lib.github.io/filelock,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">filelock</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.0.3.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/filelock/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="filelock">filelock<a class="anchor" aria-label="anchor" href="#filelock"></a>
</h1></div>
<blockquote>
<p>Portable File Locking</p>
</blockquote>
<!-- badges: start -->

<p>Place an exclusive or shared lock on a file. It uses <code>LockFile</code> on Windows and <code>fcntl</code> locks on Unix-like systems.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Install the package from CRAN as usual:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"filelock"</span><span class="op">)</span></span></code></pre></div>
<p>Install the development version from GitHub:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pak.html" class="external-link">pak</a></span><span class="op">(</span><span class="st">"r-lib/filelock"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-lib.github.io/filelock/">filelock</a></span><span class="op">)</span></span></code></pre></div>
<p>This is R process 1, it gets an exclusive lock. If you want to lock file <code>myfile</code>, always create a separate lock file instead of placing the lock on this file directly!</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R1</span><span class="op">&gt;</span> <span class="va">lck</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/lock.html">lock</a></span><span class="op">(</span><span class="st">"/tmp/myfile.lck"</span><span class="op">)</span></span></code></pre></div>
<p>This is R process 2, it fails to acquire a lock.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R2</span><span class="op">&gt;</span> <span class="fu"><a href="reference/lock.html">lock</a></span><span class="op">(</span><span class="st">"/tmp/myfile.lck"</span>, timeout <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>Specifying a timeout interval, before giving up:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R2</span><span class="op">&gt;</span> <span class="fu"><a href="reference/lock.html">lock</a></span><span class="op">(</span><span class="st">"/tmp/myfile.lck"</span>, timeout <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span></code></pre></div>
<p>Wait indefinetely:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R2</span><span class="op">&gt;</span> <span class="fu"><a href="reference/lock.html">lock</a></span><span class="op">(</span><span class="st">"/tmp/myfile.lck"</span>, timeout <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<p>Once R process 1 released the lock (or terminated), R process 2 can acquire the lock:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R1</span><span class="op">&gt;</span> <span class="fu"><a href="reference/lock.html">unlock</a></span><span class="op">(</span><span class="va">lck</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R2</span><span class="op">&gt;</span> <span class="fu"><a href="reference/lock.html">lock</a></span><span class="op">(</span><span class="st">"/tmp/myfile.lck"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Lock on ‘/tmp/myfile.lck’</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h2>
<div class="section level3">
<h3 id="warning">Warning<a class="anchor" aria-label="anchor" href="#warning"></a>
</h3>
<p>Always use special files for locking. I.e. if you want to restict access to a certain file, do <em>not</em> place the lock on this file. Create a special file, e.g. by appending <code>.lock</code> to the original file name and place the lock on that. (The <code><a href="reference/lock.html">lock()</a></code> function creates the file for you, actually, if it does not exist.) Reading from or writing to a locked file has undefined behavior! (See more about this below at the Internals Section.)</p>
<p>It is hard to determine whether and when it is safe to remove these special files, so our current recommendation is just to leave them around.</p>
<p>It is best to leave the special lock file empty, simply because on some OSes you cannot write to it (or read from it), once the lock is in place.</p>
</div>
<div class="section level3">
<h3 id="advisory-locks">Advisory Locks:<a class="anchor" aria-label="anchor" href="#advisory-locks"></a>
</h3>
<p>All locks set by this package might be advisory. A process that does not respect this locking machanism may be able to read and write the locked file, or even remove it (assuming it has capabilities to do so).</p>
</div>
<div class="section level3">
<h3 id="unlock-on-termination">Unlock on Termination:<a class="anchor" aria-label="anchor" href="#unlock-on-termination"></a>
</h3>
<p>If a process terminates (with a normal exit, a crash or on a signal), the lock(s) it is holding are automatically released.</p>
<p>If the R object that represents the lock (the return value of <code>lock</code>) goes out of scope, then the lock will be released automatically as soon as the object is garbage collected. This is more of a safety mechanism, and the user should still <code><a href="reference/lock.html">unlock()</a></code> locks manually, maybe using <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">base::on.exit()</a></code>, so that the lock is released in case of errors as well, as soon as possible.</p>
</div>
<div class="section level3">
<h3 id="special-file-systems">Special File Systems:<a class="anchor" aria-label="anchor" href="#special-file-systems"></a>
</h3>
<p>File locking needs support from the file system, and some <em>non-standard</em> file systems do not support it. For example on network file systems like NFS or CIFS, user mode file systems like <code>sshfs</code> or <code>ftpfs</code>, etc., support might vary. Recent Linux versions and recent NFS versions (from version 3) do support file locking, if enabled.</p>
<p>In theory it is possible to simply test for lock support, using two child processes and a timeout, but <code>filelock</code> does not do this currently.</p>
</div>
<div class="section level3">
<h3 id="locking-part-of-a-file">Locking Part of a File:<a class="anchor" aria-label="anchor" href="#locking-part-of-a-file"></a>
</h3>
<p>While this is possible in general, <code>filelock</code> does not suport it currently. The main purpose of <code>filelock</code> is to lock using special lock files, and locking part of these is not really useful.</p>
</div>
<div class="section level3">
<h3 id="internals-on-unix">Internals on Unix:<a class="anchor" aria-label="anchor" href="#internals-on-unix"></a>
</h3>
<p>On Unix (i.e. Linux, macOS, etc.), we use <code>fcntl</code> to acquire and release the locks. You can read more about it here: <a href="https://www.gnu.org/software/libc/manual/html_node/File-Locks.html" class="external-link uri">https://www.gnu.org/software/libc/manual/html_node/File-Locks.html</a></p>
<p>Some important points:</p>
<ul>
<li>The lock is put on a file descriptor, which is kept open, until the lock is released.</li>
<li>A process can only have one kind of lock set for a given file.</li>
<li>When any file descriptor for that file is closed by the process, all of the locks that process holds on that file are released, even if the locks were made using other descriptors that remain open. Note that in R, using a one-shot function call to modify the file opens and closes a file descriptor to it, so the lock will be released. (This is one of the main reasons for using special lock files, instead of putting the lock on the actual file.)</li>
<li>Locks are not inherited by child processes created using fork.</li>
<li>For lock requests with finite timeout intervals, we set an alarm, and temporarily install a signal handler for it. R is single threaded, so no other code can be running, while the process is waiting to acquire the lock. The signal handler is restored to its original value immediately after the lock is acquired or the timeout expires. (It is actually restored from the signal handler, so there should be no race conditions here. However, if multiple <code>SIGALRM</code> signals are delivered via a single call to the signal handler, then alarms might get lost. Currently base R does not use the <code>SIGALRM</code> signal for anything, but other packages might.)</li>
</ul>
</div>
<div class="section level3">
<h3 id="internals-on-windows">Internals on Windows:<a class="anchor" aria-label="anchor" href="#internals-on-windows"></a>
</h3>
<p>On Windows, <code>LockFileEx</code> is used to create the lock on the file. If a finite timeout is specified for the lock request, asynchronous (overlapped) I/O is used to wait for the locking event with a timeout. See more about <code>LockFileEx</code> on the first hit here: <a href="https://msdn.microsoft.com/en-us/library/aa365203.aspx" class="external-link uri">https://msdn.microsoft.com/en-us/library/aa365203.aspx</a></p>
<p>Some important points:</p>
<ul>
<li>
<code>LockFileEx</code> locks are mandatory (as opposed to advisory), so indeed no other processes have access to the locked file. Actually, even the locking process has no access to it through a different file handle, than the one used for locking. In general, R cannot read from the locked file, and cannot write to it. (Although, the current R version does not fail, it just does nothing, which is quite puzzling.) Remember, always use a special lock file, instead of putting the lock on the main file, so that you are not affected by these problems.</li>
<li>Inherited handles do not provide access to the child process.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="code-of-conduct">Code of Conduct<a class="anchor" aria-label="anchor" href="#code-of-conduct"></a>
</h2>
<p>Please note that the fs project is released with a <a href="https://r-lib.github.io/filelock/CODE_OF_CONDUCT.html">Contributor Code of Conduct</a>. By contributing to this project, you agree to abide by its terms.</p>
</div>
<div class="section level2">
<h2 id="license">License<a class="anchor" aria-label="anchor" href="#license"></a>
</h2>
<p>MIT © RStudio</p>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=filelock" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/r-lib/filelock/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/r-lib/filelock/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing filelock</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a> <br><small class="roles"> Author, maintainer </small>  </li>
<li>
<a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" style="margin-bottom: 3px;"></a> <br><small class="roles"> Copyright holder, funder </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/r-lib/filelock/actions" class="external-link"><img src="https://github.com/r-lib/filelock/workflows/R-CMD-check/badge.svg" alt="R build status"></a></li>
<li><a href="https://www.r-pkg.org/pkg/filelock" class="external-link"><img src="https://www.r-pkg.org/badges/version/filelock"></a></li>
<li><a href="https://www.r-pkg.org/pkg/filelock" class="external-link"><img src="https://cranlogs.r-pkg.org/badges/filelock" alt="CRAN RStudio mirror downloads"></a></li>
<li><a href="https://app.codecov.io/github/r-lib/filelock?branch=main" class="external-link"><img src="https://img.shields.io/codecov/c/github/r-lib/filelock/main.svg" alt="Coverage Status"></a></li>
<li><a href="https://app.codecov.io/gh/r-lib/filelock?branch=main" class="external-link"><img src="https://codecov.io/gh/r-lib/filelock/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://github.com/r-lib/filelock/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/r-lib/filelock/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer>
</body>
</html>
